<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ‰¹é‡å‘é€å®šåˆ¶é‚®ä»¶ | Bulk Custom Email Helper</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #007AFF; --success: #28a745; --bg: #f5f5f7; }
        body { font-family: -apple-system, "SF Pro Display", "Segoe UI", sans-serif; background-color: var(--bg); margin: 0; padding: 60px 15px; color: #1d1d1f; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .app-container { width: 100%; max-width: 760px; background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 24px; border: 1px solid rgba(255,255,255,0.4); box-shadow: 0 20px 60px rgba(0,0,0,0.08); padding: 50px; margin-bottom: 30px; flex: 1; }
        .header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 28px; font-weight: 700; margin: 0; color: #1d1d1f; }
        .subtitle { font-size: 14px; color: #86868b; margin-top: 8px; }
        .instruction-box { background: #f0f7ff; border-radius: 16px; padding: 25px; margin-bottom: 35px; border: 1px solid #cce5ff; }
        .instruction-box h3 { margin-top: 0; font-size: 16px; color: #004085; }
        .instruction-box p { margin: 10px 0; font-size: 14px; color: #004085; line-height: 1.6; }
        .instruction-box ul { margin: 5px 0; padding-left: 20px; font-size: 13px; color: #0056b3; }
        .section { margin-bottom: 30px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 10px; }
        label { display: block; font-size: 15px; font-weight: 600; color: #1d1d1f; margin-bottom: 12px; }
        input[type="text"], input[type="email"] { width: 100%; padding: 14px 18px; border: 1px solid #d2d2d7; border-radius: 12px; font-size: 15px; box-sizing: border-box; background: #fff; transition: all 0.2s ease; }
        .file-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .file-zone { background: #fafafa; border: 2px dashed #d2d2d7; border-radius: 16px; padding: 30px 20px; text-align: center; transition: 0.2s; cursor: pointer; }
        .main-btn { width: 100%; background: var(--primary); color: white; border: none; padding: 18px; border-radius: 16px; font-size: 17px; font-weight: 600; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(0,122,255,0.2); }
        .main-btn:hover { background: #0056b3; transform: translateY(-2px); }
        #list { margin-top: 45px; border-top: 1px solid #eee; }
        .row { display: flex; justify-content: space-between; align-items: center; padding: 20px 10px; border-bottom: 1px solid #f2f2f7; animation: fadeIn 0.4s ease; }
        .copy-btn { background: var(--success); color: white; border: none; padding: 12px 24px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .copy-btn.done { background: #e5e5ea; color: #8e8e93; }
        .hidden { display: none; }
        .footer { text-align: center; padding: 30px; font-size: 13px; color: #8e8e93; font-weight: 500; }
        .footer a { color: #8e8e93; text-decoration: none; border-bottom: 1px solid transparent; transition: 0.2s; }
        .footer a:hover { color: var(--primary); border-bottom: 1px solid var(--primary); }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <h1>æ‰¹é‡å‘é€å®šåˆ¶é‚®ä»¶</h1>
        <div class="subtitle">Bulk Custom Email Helper (Win/Mac Universal)</div>
    </div>

    <div class="instruction-box">
        <h3>ğŸ’¡ æ“ä½œæµç¨‹ä¸æŒ‡å¼• / Instructions</h3>
        <p>1. å‡†å¤‡æ–‡ä»¶: Excel éœ€åŒ…å« <b>Name</b> å’Œ <b>Email</b> åˆ—ï¼›HTML ä¸º Word å¯¼å‡ºçš„æ¨¡æ¿ã€‚</p>
        <p>2. è®¾ç½®å‚æ•°: è¾“å…¥ç§°å‘¼ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆæˆ <b>[ç§°å‘¼] + [æ”¶ä»¶äººå§“å] + [æ­£æ–‡]</b>ã€‚</p>
        <p>3. ç”Ÿæˆä¸å‘é€: ç‚¹å‡»å¤åˆ¶å¹¶å”¤èµ·ï¼Œåœ¨é‚®ä»¶ App æŒ‰ <b>Cmd/Ctrl+V</b> ç²˜è´´ã€‚</p>
    </div>
    
    <div class="input-grid">
        <div class="section">
            <label>é‚®ä»¶ç§°å‘¼ / Salutation</label>
            <input type="text" id="salutationInput" value="Dear Prof.">
        </div>
        <div class="section">
            <label>æŠ„é€åœ°å€ / CC Address</label>
            <input type="text" id="ccInput" placeholder="e.g., a@zju.edu.cn; b@zju.edu.cn">
        </div>
    </div>

    <div class="section">
        <label>é‚®ä»¶æ ‡é¢˜ / Subject</label>
        <input type="text" id="subjectInput" placeholder="è¾“å…¥æ ‡é¢˜æˆ–è‡ªåŠ¨æå–">
    </div>

    <div class="file-grid">
        <div class="section">
            <label>1. ä¸Šä¼ æ”¶ä»¶äººè¡¨æ ¼ (Excel)</label>
            <div class="file-zone"><input type="file" id="excelInput" accept=".xlsx, .xls"></div>
        </div>
        <div class="section">
            <label>2. ä¸Šä¼ é‚®ä»¶æ¨¡æ¿ (HTML)</label>
            <div class="file-zone"><input type="file" id="htmlInput" accept=".html"></div>
        </div>
    </div>

    <button class="main-btn" onclick="runApp()">è§£æå¹¶ç”Ÿæˆå‘é€åå• / Generate List</button>
    <div id="list"></div>
</div>

<div class="footer">
    Designed & Developed by <a href="https://person.zju.edu.cn/YangkunDu" target="_blank">Dr. Yangkun Du (DYK)</a> | Zhejiang University
</div>

<script>
    let currentBody = "";
    document.getElementById('htmlInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const text = await file.text();
            const doc = new DOMParser().parseFromString(text, 'text/html');
            if (doc.title) document.getElementById('subjectInput').value = doc.title;
            currentBody = doc.body ? doc.body.innerHTML : text;
        }
    });

    async function runApp() {
        const excelFile = document.getElementById('excelInput').files[0];
        const subject = document.getElementById('subjectInput').value || "Invitation";
        const salutation = document.getElementById('salutationInput').value || "Dear Prof.";
        const ccRaw = document.getElementById('ccInput').value;
        const listDiv = document.getElementById('list');
        if (!excelFile || !currentBody) { alert("è¯·å®Œæ•´é€‰æ‹©æ–‡ä»¶ï¼"); return; }
        const formattedCC = ccRaw.replace(/ï¼›/g, ";").replace(/ï¼Œ/g, ";").replace(/,/g, ";").replace(/\s+/g, ";");
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            listDiv.innerHTML = `<p style="font-size:14px; color:#86868b; margin:25px 0;">âœ… å·²å‡†å¤‡å¥½ ${rows.length} ä½æ”¶ä»¶äºº:</p>`;
            rows.forEach((row, i) => {
                const name = row.Name || row['å§“å'] || row.name || "Professor";
                const email = row.Email || row['é‚®ç®±'] || row.email;
                if (!email) return;
                const fullHTML = `<div style="font-family:Helvetica,Arial,sans-serif;font-size:16px;color:#0d0e11;"><p>${salutation} ${name},</p>${currentBody}</div>`;
                const rowEl = document.createElement('div');
                rowEl.className = 'row';
                rowEl.innerHTML = `<div class="user-meta"><strong>${name}</strong><span>To: ${email}</span></div><button class="copy-btn" id="btn-${i}">å¤åˆ¶å¹¶å”¤èµ·</button><div id="store-${i}" class="hidden">${fullHTML}</div>`;
                rowEl.querySelector('button').onclick = async function() {
                    const html = document.getElementById(`store-${i}`).innerHTML;
                    const text = document.getElementById(`store-${i}`).innerText;
                    try {
                        const blob = new Blob([html], { type: "text/html" });
                        await navigator.clipboard.write([new ClipboardItem({ "text/html": blob, "text/plain": new Blob([text], { type: "text/plain" }) })]);
                        let mailto = `mailto:${email}?subject=${encodeURIComponent(subject)}`;
                        if(formattedCC) mailto += `&cc=${encodeURIComponent(formattedCC)}`;
                        mailto += `&body=%0A%0A(æ­£æ–‡å·²è‡ªåŠ¨å¤åˆ¶ï¼Œç›´æ¥ç²˜è´´)`;
                        window.location.href = mailto;
                        this.innerText = "å·²å¤„ç† âœ…";
                        this.classList.add('done');
                    } catch (err) { alert("å¤åˆ¶å¤±è´¥"); }
                };
                listDiv.appendChild(rowEl);
            });
        };
        reader.readAsArrayBuffer(excelFile);
    }
</script>
</body>
</html>
